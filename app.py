from flask import Flask, render_template, request, jsonify

app = Flask(__name__)

# 腸活タイプの定義
INTESTINE_TYPES = {
    "ストレス敏感型": {
        "description": "ストレスに敏感で、緊張や不安を感じやすいタイプ。完璧主義で責任感が強く、プレッシャーに弱い傾向があります。",
        "symptoms": ["お腹の張り", "食欲不振", "胃の不快感", "緊張感", "疲れやすさ"],
        "advice": [
            "朝の15分瞑想で心を落ち着かせる",
            "深呼吸を1日3回、5分ずつ行う",
            "完璧を求めすぎない、80%でOKにする",
            "カフェインを控えめにする",
            "就寝前のホットミルクでリラックス",
            "週末は完全に仕事を忘れる時間を作る",
        ],
        "foods": [
            "カモミールティー",
            "ラベンダーティー",
            "バナナ",
            "アボカド",
            "ナッツ",
            "ダークチョコレート",
            "ヤーコン",
            "菊芋",
        ],
    },
    "デジタル疲労型": {
        "description": "スマホやPCの長時間使用で目や体が疲れやすいタイプ。ブルーライトの影響で睡眠の質が低下しやすい傾向があります。",
        "symptoms": ["目の疲れ", "頭痛", "集中力低下", "イライラ", "疲労感", "肩こり"],
        "advice": [
            "就寝2時間前からスマホ使用を控える",
            "ブルーライトカットメガネを着用",
            "朝日を10分間浴びる",
            "デジタルデトックス日を週1回設ける",
            "寝る前の読書でリラックス",
            "1時間ごとに5分の休憩を取る",
        ],
        "foods": [
            "ブルーベリー",
            "ほうれん草",
            "サーモン",
            "卵",
            "アーモンド",
            "緑茶",
            "ヤーコン",
            "チコリ",
        ],
    },
    "運動不足・座りっぱなし型": {
        "description": "デスクワーク中心で運動不足、座りっぱなしの生活で体が硬くなりやすいタイプ。血行不良と筋力低下が特徴です。",
        "symptoms": ["お腹の張り", "むくみ", "冷え性", "肩こり", "腰痛", "疲労感"],
        "advice": [
            "30分座ったら必ず立ち上がって歩く",
            "通勤時に1駅分歩く",
            "エレベーターの代わりに階段を使う",
            "座りながらできる腹筋運動を1日3回",
            "ストレッチを朝晩5分ずつ",
            "週末は必ず外に出て運動する",
        ],
        "foods": [
            "玄米",
            "キムチ",
            "納豆",
            "海藻",
            "きのこ",
            "生姜",
            "にんにく",
            "ヤーコン",
            "ごぼう",
        ],
    },
    "食生活乱れ型": {
        "description": "朝食抜き、夜遅い食事、偏食などで食生活が乱れがちなタイプ。食事のリズムが整っていない傾向があります。",
        "symptoms": ["お腹の張り", "疲労感", "肌の調子が悪い", "疲れやすさ", "体調不良"],
        "advice": [
            "朝食は必ず食べる（ヨーグルト+フルーツでもOK）",
            "夕食は就寝3時間前までに済ませる",
            "食物繊維を意識的に摂取",
            "発酵食品を毎食1品は食べる",
            "水分を1日2L以上摂取",
            "食事は30分以上かけてゆっくり食べる",
        ],
        "foods": [
            "キムチ",
            "ぬか漬け",
            "味噌",
            "納豆",
            "ヨーグルト",
            "野菜",
            "果物",
            "海藻",
            "ヤーコン",
            "菊芋",
            "チコリ",
        ],
    },
    "睡眠不足・生活リズム乱れ型": {
        "description": "睡眠不足や不規則な生活で体のリズムが乱れやすいタイプ。体内時計が狂いやすい傾向があります。",
        "symptoms": ["疲労感", "イライラ", "集中力低下", "めまい", "動悸", "体調不良"],
        "advice": [
            "毎日同じ時間に起床・就寝する",
            "7-8時間の十分な睡眠を取る",
            "就寝前のスマホ・PC使用を控える",
            "朝日を浴びる",
            "就寝前のカフェインを避ける",
            "リラックスできる就寝ルーティンを作る",
        ],
        "foods": [
            "バナナ",
            "牛乳",
            "ハーブティー",
            "ナッツ",
            "はちみつ",
            "サーモン",
            "卵",
            "ヤーコン",
            "菊芋",
        ],
    },
    "加齢・筋力低下型": {
        "description": "加齢による筋力低下で体の動きが鈍くなりやすいタイプ。腹筋力の低下と代謝の悪化が特徴です。",
        "symptoms": ["お腹の張り", "食欲不振", "疲労感", "免疫力低下", "冷え性", "むくみ"],
        "advice": [
            "軽い筋力トレーニングを週3回行う",
            "ウォーキングを1日30分以上",
            "水分を十分に摂取（1日2L以上）",
            "食物繊維を意識的に摂る",
            "発酵食品で腸内環境を整える",
            "定期的な健康診断を受ける",
        ],
        "foods": [
            "ヨーグルト",
            "納豆",
            "味噌",
            "野菜",
            "果物",
            "海藻",
            "きのこ",
            "玄米",
            "ヤーコン",
            "菊芋",
            "ごぼう",
        ],
    },
    "腸内環境悪化型": {
        "description": "抗生物質の使用や偏った食事で腸内細菌のバランスが崩れやすいタイプ。食生活の改善が必要です。",
        "symptoms": ["お腹の張り", "疲労感", "肌の調子が悪い", "アレルギー", "体調不良"],
        "advice": [
            "食物繊維を1日30g以上摂取",
            "発酵食品を毎食食べる",
            "砂糖と人工甘味料を控える",
            "抗生物質使用後は特に注意",
            "腸内環境を整える食材を積極的に摂る",
        ],
        "foods": [
            "キムチ",
            "ぬか漬け",
            "味噌",
            "納豆",
            "ヨーグルト",
            "野菜",
            "果物",
            "海藻",
            "きのこ",
            "ヤーコン",
            "菊芋",
            "チコリ",
            "ごぼう",
            "玉ねぎ",
        ],
    },
}

# チェック質問
QUESTIONS = [
    {
        "id": 1,
        "question": "最近のストレスレベルは？",
        "options": [
            {
                "text": "非常に高い（常に緊張している）",
                "scores": {
                    "ストレス敏感型": 4,
                    "デジタル疲労型": 2,
                    "運動不足・座りっぱなし型": 1,
                    "食生活乱れ型": 1,
                    "睡眠不足・生活リズム乱れ型": 2,
                    "加齢・筋力低下型": 0,
                    "腸内環境悪化型": 1,
                },
            },
            {
                "text": "やや高い（時々緊張する）",
                "scores": {
                    "ストレス敏感型": 3,
                    "デジタル疲労型": 1,
                    "運動不足・座りっぱなし型": 1,
                    "食生活乱れ型": 1,
                    "睡眠不足・生活リズム乱れ型": 1,
                    "加齢・筋力低下型": 0,
                    "腸内環境悪化型": 1,
                },
            },
            {
                "text": "普通（たまに緊張する）",
                "scores": {
                    "ストレス敏感型": 1,
                    "デジタル疲労型": 1,
                    "運動不足・座りっぱなし型": 1,
                    "食生活乱れ型": 1,
                    "睡眠不足・生活リズム乱れ型": 1,
                    "加齢・筋力低下型": 0,
                    "腸内環境悪化型": 1,
                },
            },
            {
                "text": "低い（ほとんど緊張しない）",
                "scores": {
                    "ストレス敏感型": 0,
                    "デジタル疲労型": 1,
                    "運動不足・座りっぱなし型": 1,
                    "食生活乱れ型": 1,
                    "睡眠不足・生活リズム乱れ型": 1,
                    "加齢・筋力低下型": 0,
                    "腸内環境悪化型": 1,
                },
            },
        ],
    },
    {
        "id": 2,
        "question": "1日のデジタル機器使用時間は？",
        "options": [
            {
                "text": "8時間以上（仕事+プライベート）",
                "scores": {
                    "ストレス敏感型": 1,
                    "デジタル疲労型": 4,
                    "運動不足・座りっぱなし型": 3,
                    "食生活乱れ型": 1,
                    "睡眠不足・生活リズム乱れ型": 2,
                    "加齢・筋力低下型": 0,
                    "腸内環境悪化型": 1,
                },
            },
            {
                "text": "6-8時間（仕事中心）",
                "scores": {
                    "ストレス敏感型": 1,
                    "デジタル疲労型": 3,
                    "運動不足・座りっぱなし型": 2,
                    "食生活乱れ型": 1,
                    "睡眠不足・生活リズム乱れ型": 1,
                    "加齢・筋力低下型": 0,
                    "腸内環境悪化型": 1,
                },
            },
            {
                "text": "4-6時間（適度）",
                "scores": {
                    "ストレス敏感型": 1,
                    "デジタル疲労型": 1,
                    "運動不足・座りっぱなし型": 1,
                    "食生活乱れ型": 1,
                    "睡眠不足・生活リズム乱れ型": 1,
                    "加齢・筋力低下型": 0,
                    "腸内環境悪化型": 1,
                },
            },
            {
                "text": "4時間未満（少ない）",
                "scores": {
                    "ストレス敏感型": 1,
                    "デジタル疲労型": 0,
                    "運動不足・座りっぱなし型": 1,
                    "食生活乱れ型": 1,
                    "睡眠不足・生活リズム乱れ型": 1,
                    "加齢・筋力低下型": 0,
                    "腸内環境悪化型": 1,
                },
            },
        ],
    },
    {
        "id": 3,
        "question": "1日の運動時間は？",
        "options": [
            {
                "text": "30分以上（積極的に運動）",
                "scores": {
                    "ストレス敏感型": 1,
                    "デジタル疲労型": 1,
                    "運動不足・座りっぱなし型": 0,
                    "食生活乱れ型": 1,
                    "睡眠不足・生活リズム乱れ型": 1,
                    "加齢・筋力低下型": 0,
                    "腸内環境悪化型": 1,
                },
            },
            {
                "text": "15-30分（軽い運動）",
                "scores": {
                    "ストレス敏感型": 1,
                    "デジタル疲労型": 1,
                    "運動不足・座りっぱなし型": 1,
                    "食生活乱れ型": 1,
                    "睡眠不足・生活リズム乱れ型": 1,
                    "加齢・筋力低下型": 0,
                    "腸内環境悪化型": 1,
                },
            },
            {
                "text": "15分未満（ほとんど運動しない）",
                "scores": {
                    "ストレス敏感型": 1,
                    "デジタル疲労型": 1,
                    "運動不足・座りっぱなし型": 3,
                    "食生活乱れ型": 1,
                    "睡眠不足・生活リズム乱れ型": 1,
                    "加齢・筋力低下型": 1,
                    "腸内環境悪化型": 1,
                },
            },
            {
                "text": "全く運動しない",
                "scores": {
                    "ストレス敏感型": 1,
                    "デジタル疲労型": 1,
                    "運動不足・座りっぱなし型": 4,
                    "食生活乱れ型": 1,
                    "睡眠不足・生活リズム乱れ型": 1,
                    "加齢・筋力低下型": 2,
                    "腸内環境悪化型": 1,
                },
            },
        ],
    },
    {
        "id": 4,
        "question": "朝食の習慣は？",
        "options": [
            {
                "text": "毎日しっかり食べる",
                "scores": {
                    "ストレス敏感型": 1,
                    "デジタル疲労型": 1,
                    "運動不足・座りっぱなし型": 1,
                    "食生活乱れ型": 0,
                    "睡眠不足・生活リズム乱れ型": 1,
                    "加齢・筋力低下型": 0,
                    "腸内環境悪化型": 0,
                },
            },
            {
                "text": "軽く食べる（ヨーグルトなど）",
                "scores": {
                    "ストレス敏感型": 1,
                    "デジタル疲労型": 1,
                    "運動不足・座りっぱなし型": 1,
                    "食生活乱れ型": 1,
                    "睡眠不足・生活リズム乱れ型": 1,
                    "加齢・筋力低下型": 0,
                    "腸内環境悪化型": 1,
                },
            },
            {
                "text": "時々食べる",
                "scores": {
                    "ストレス敏感型": 1,
                    "デジタル疲労型": 1,
                    "運動不足・座りっぱなし型": 1,
                    "食生活乱れ型": 2,
                    "睡眠不足・生活リズム乱れ型": 1,
                    "加齢・筋力低下型": 0,
                    "腸内環境悪化型": 2,
                },
            },
            {
                "text": "ほとんど食べない",
                "scores": {
                    "ストレス敏感型": 1,
                    "デジタル疲労型": 1,
                    "運動不足・座りっぱなし型": 1,
                    "食生活乱れ型": 4,
                    "睡眠不足・生活リズム乱れ型": 2,
                    "加齢・筋力低下型": 0,
                    "腸内環境悪化型": 3,
                },
            },
        ],
    },
    {
        "id": 5,
        "question": "発酵食品の摂取頻度は？",
        "options": [
            {
                "text": "毎食食べる",
                "scores": {
                    "ストレス敏感型": 1,
                    "デジタル疲労型": 1,
                    "運動不足・座りっぱなし型": 1,
                    "食生活乱れ型": 0,
                    "睡眠不足・生活リズム乱れ型": 1,
                    "加齢・筋力低下型": 0,
                    "腸内環境悪化型": 0,
                },
            },
            {
                "text": "1日2回",
                "scores": {
                    "ストレス敏感型": 1,
                    "デジタル疲労型": 1,
                    "運動不足・座りっぱなし型": 1,
                    "食生活乱れ型": 1,
                    "睡眠不足・生活リズム乱れ型": 1,
                    "加齢・筋力低下型": 0,
                    "腸内環境悪化型": 1,
                },
            },
            {
                "text": "1日1回",
                "scores": {
                    "ストレス敏感型": 1,
                    "デジタル疲労型": 1,
                    "運動不足・座りっぱなし型": 1,
                    "食生活乱れ型": 2,
                    "睡眠不足・生活リズム乱れ型": 1,
                    "加齢・筋力低下型": 0,
                    "腸内環境悪化型": 2,
                },
            },
            {
                "text": "ほとんど食べない",
                "scores": {
                    "ストレス敏感型": 1,
                    "デジタル疲労型": 1,
                    "運動不足・座りっぱなし型": 1,
                    "食生活乱れ型": 3,
                    "睡眠不足・生活リズム乱れ型": 1,
                    "加齢・筋力低下型": 0,
                    "腸内環境悪化型": 4,
                },
            },
        ],
    },
    {
        "id": 6,
        "question": "お腹の調子は？",
        "options": [
            {
                "text": "とても良い",
                "scores": {
                    "ストレス敏感型": 0,
                    "デジタル疲労型": 0,
                    "運動不足・座りっぱなし型": 0,
                    "食生活乱れ型": 0,
                    "睡眠不足・生活リズム乱れ型": 0,
                    "加齢・筋力低下型": 0,
                    "腸内環境悪化型": 0,
                },
            },
            {
                "text": "良い",
                "scores": {
                    "ストレス敏感型": 1,
                    "デジタル疲労型": 1,
                    "運動不足・座りっぱなし型": 1,
                    "食生活乱れ型": 1,
                    "睡眠不足・生活リズム乱れ型": 1,
                    "加齢・筋力低下型": 1,
                    "腸内環境悪化型": 1,
                },
            },
            {
                "text": "普通",
                "scores": {
                    "ストレス敏感型": 2,
                    "デジタル疲労型": 2,
                    "運動不足・座りっぱなし型": 2,
                    "食生活乱れ型": 2,
                    "睡眠不足・生活リズム乱れ型": 2,
                    "加齢・筋力低下型": 2,
                    "腸内環境悪化型": 2,
                },
            },
            {
                "text": "悪い",
                "scores": {
                    "ストレス敏感型": 3,
                    "デジタル疲労型": 3,
                    "運動不足・座りっぱなし型": 3,
                    "食生活乱れ型": 3,
                    "睡眠不足・生活リズム乱れ型": 3,
                    "加齢・筋力低下型": 3,
                    "腸内環境悪化型": 3,
                },
            },
        ],
    },
    {
        "id": 7,
        "question": "平均睡眠時間は？",
        "options": [
            {
                "text": "8時間以上（十分な睡眠）",
                "scores": {
                    "ストレス敏感型": 1,
                    "デジタル疲労型": 1,
                    "運動不足・座りっぱなし型": 1,
                    "食生活乱れ型": 1,
                    "睡眠不足・生活リズム乱れ型": 0,
                    "加齢・筋力低下型": 0,
                    "腸内環境悪化型": 1,
                },
            },
            {
                "text": "7-8時間（適度な睡眠）",
                "scores": {
                    "ストレス敏感型": 1,
                    "デジタル疲労型": 1,
                    "運動不足・座りっぱなし型": 1,
                    "食生活乱れ型": 1,
                    "睡眠不足・生活リズム乱れ型": 0,
                    "加齢・筋力低下型": 0,
                    "腸内環境悪化型": 1,
                },
            },
            {
                "text": "6-7時間（やや不足）",
                "scores": {
                    "ストレス敏感型": 1,
                    "デジタル疲労型": 1,
                    "運動不足・座りっぱなし型": 1,
                    "食生活乱れ型": 1,
                    "睡眠不足・生活リズム乱れ型": 2,
                    "加齢・筋力低下型": 0,
                    "腸内環境悪化型": 1,
                },
            },
            {
                "text": "6時間未満（睡眠不足）",
                "scores": {
                    "ストレス敏感型": 1,
                    "デジタル疲労型": 1,
                    "運動不足・座りっぱなし型": 1,
                    "食生活乱れ型": 1,
                    "睡眠不足・生活リズム乱れ型": 4,
                    "加齢・筋力低下型": 0,
                    "腸内環境悪化型": 1,
                },
            },
        ],
    },
    {
        "id": 8,
        "question": "年齢は？",
        "options": [
            {
                "text": "20代以下",
                "scores": {
                    "ストレス敏感型": 1,
                    "デジタル疲労型": 2,
                    "運動不足・座りっぱなし型": 1,
                    "食生活乱れ型": 2,
                    "睡眠不足・生活リズム乱れ型": 2,
                    "加齢・筋力低下型": 0,
                    "腸内環境悪化型": 1,
                },
            },
            {
                "text": "30-40代",
                "scores": {
                    "ストレス敏感型": 1,
                    "デジタル疲労型": 2,
                    "運動不足・座りっぱなし型": 1,
                    "食生活乱れ型": 1,
                    "睡眠不足・生活リズム乱れ型": 1,
                    "加齢・筋力低下型": 0,
                    "腸内環境悪化型": 1,
                },
            },
            {
                "text": "50-60代",
                "scores": {
                    "ストレス敏感型": 1,
                    "デジタル疲労型": 1,
                    "運動不足・座りっぱなし型": 1,
                    "食生活乱れ型": 1,
                    "睡眠不足・生活リズム乱れ型": 1,
                    "加齢・筋力低下型": 2,
                    "腸内環境悪化型": 1,
                },
            },
            {
                "text": "70代以上",
                "scores": {
                    "ストレス敏感型": 1,
                    "デジタル疲労型": 0,
                    "運動不足・座りっぱなし型": 1,
                    "食生活乱れ型": 1,
                    "睡眠不足・生活リズム乱れ型": 1,
                    "加齢・筋力低下型": 4,
                    "腸内環境悪化型": 1,
                },
            },
        ],
    },
]


@app.route("/")
def index():
    return render_template("index.html")


@app.route("/questions")
def questions():
    return render_template("questions.html", questions=QUESTIONS)


@app.route("/check", methods=["POST"])
def check():
    data = request.get_json()
    answers = data.get("answers", [])

    # スコア計算
    scores = {type_name: 0 for type_name in INTESTINE_TYPES.keys()}

    for answer in answers:
        question_id = answer["questionId"]
        option_index = answer["optionIndex"]

        if question_id <= len(QUESTIONS) and option_index < len(QUESTIONS[question_id - 1]["options"]):
            option = QUESTIONS[question_id - 1]["options"][option_index]
            for type_name, score in option["scores"].items():
                scores[type_name] += score

    # 最もスコアが高いタイプを特定
    max_score = max(scores.values())
    result_type = [k for k, v in scores.items() if v == max_score][0]

    return jsonify({"result_type": result_type, "type_info": INTESTINE_TYPES[result_type], "scores": scores})


@app.route("/result")
def result():
    return render_template("result.html")


if __name__ == "__main__":
    app.run(debug=True, host="0.0.0.0", port=8080)
